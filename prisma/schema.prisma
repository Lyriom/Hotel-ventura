generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ========== USUARIOS DE LOGIN ==========
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      String   @default("cliente") // 'admin' | 'recepcionista' | 'cliente'
  createdAt DateTime @default(now())
}

/// ========== ROLES Y USUARIOS DEL HOTEL ==========
model Roles {
  IdRol     Int        @id @default(autoincrement())
  NombreRol String     @unique      // ← un rol no se repite
  Usuarios  Usuarios[]
}

model Usuarios {
  IdUsuario      Int       @id @default(autoincrement())
  Nombre         String
  Usuario        String    @unique   // ← username único
  ContrasenaHash String
  IdRol          Int

  Rol            Roles      @relation(fields: [IdRol], references: [IdRol])
  Reservas       Reservas[]
  Facturas       Facturas[]
}

/// ========== CLIENTES ==========
model Clientes {
  IdCliente          Int       @id @default(autoincrement())
  Nombre             String
  Apellido           String
  Ciudad             String
  Correo             String    @unique   // ← un email por cliente
  Telefono           String
  DocumentoIdentidad String?   @unique   // ← si lo tiene, que no se repita

  Reservas           Reservas[]
  Estancias          Estancias[]
  Facturas           Facturas[]
}

/// ========== TIPOS Y HABITACIONES ==========
model TiposHabitacion {
  IdTipoHabitacion Int           @id @default(autoincrement())
  NombreTipo       String        @unique
  Capacidad        Int
  PrecioBaseNoche  Decimal?      
  PrecioBaseHora   Decimal?

  Habitaciones     Habitaciones[]
}

model Habitaciones {
  IdHabitacion       Int                 @id @default(autoincrement())
  Numero             String              @unique    // ← número de habitación único
  IdTipoHabitacion   Int
  NumeroCamas        Int
  TipoTV             String
  Estado             String

  TipoHabitacion     TiposHabitacion     @relation(fields: [IdTipoHabitacion], references: [IdTipoHabitacion])
  ReservaHabitacion  ReservaHabitacion[]
  EstanciaHabitacion EstanciaHabitacion[]

  @@index([IdTipoHabitacion])
}

/// ========== RESERVAS (PLAN) ==========
model Reservas {
  IdReserva            Int                 @id @default(autoincrement())
  CodigoReserva        String?             @unique   // ← código de reserva único
  IdCliente            Int
  IdUsuario            Int?                // opcional para no romper mientras
  FechaReserva         DateTime?
  FechaEntradaPrevista DateTime?
  FechaSalidaPrevista  DateTime?
  Estado               String
  MontoTotalEstimado   Decimal?
  Observaciones        String?

  Cliente              Clientes            @relation(fields: [IdCliente], references: [IdCliente])
  Usuario              Usuarios?           @relation(fields: [IdUsuario], references: [IdUsuario])

  ReservaHabitacion    ReservaHabitacion[]
  Estancias            Estancias[]

  @@index([IdCliente])
  @@index([IdUsuario])
}

/// ========== DETALLE HABITACIONES RESERVADAS ==========
model ReservaHabitacion {
  IdReservaHabitacion Int         @id @default(autoincrement())
  IdReserva           Int
  IdHabitacion        Int
  PrecioPorNoche      Decimal?
  PrecioPorHora       Decimal?
  CantidadNoches      Int?
  CantidadHoras       Int?
  Subtotal            Decimal?

  Reserva             Reservas     @relation(fields: [IdReserva], references: [IdReserva])
  Habitacion          Habitaciones @relation(fields: [IdHabitacion], references: [IdHabitacion])

  // ← una misma habitación no puede estar dos veces en la misma reserva
  @@unique([IdReserva, IdHabitacion])
  @@index([IdHabitacion])
}

/// ========== ESTANCIAS (REAL) ==========
model Estancias {
  IdEstancia      Int                 @id @default(autoincrement())
  IdReserva       Int
  IdCliente       Int
  FechaCheckIn    DateTime?
  HoraCheckIn     DateTime?
  FechaCheckOut   DateTime?
  HoraCheckOut    DateTime?
  MontoTotalFinal Decimal?
  Estado          String

  Reserva         Reservas            @relation(fields: [IdReserva], references: [IdReserva])
  Cliente         Clientes            @relation(fields: [IdCliente], references: [IdCliente])

  EstanciaHabitacion EstanciaHabitacion[]
  Facturas           Facturas[]

  // ← un cliente no debería tener dos estancias distintas para la misma reserva
  @@unique([IdReserva, IdCliente])
  @@index([IdCliente])
}

/// ========== HABITACIONES EN ESTANCIA ==========
model EstanciaHabitacion {
  IdEstanciaHabitacion Int            @id @default(autoincrement())
  IdEstancia           Int
  IdHabitacion         Int
  FechaEntradaReal     DateTime?
  HoraEntradaReal      DateTime?
  FechaSalidaReal      DateTime?
  HoraSalidaReal       DateTime?
  TarifaPorNoche       Decimal?
  TarifaPorHora        Decimal?
  CantidadNoches       Int?
  CantidadHoras        Int?
  Subtotal             Decimal?

  Estancia             Estancias      @relation(fields: [IdEstancia], references: [IdEstancia])
  Habitacion           Habitaciones   @relation(fields: [IdHabitacion], references: [IdHabitacion])
  DetallesFactura      DetalleFactura[]

  // ← misma habitación no se repite dentro de la misma estancia
  @@unique([IdEstancia, IdHabitacion])
  @@index([IdHabitacion])
}

/// ========== FACTURAS ==========
model Facturas {
  IdFactura      Int        @id @default(autoincrement())
  NumeroFactura  String     @unique      // ← número de factura único
  IdCliente      Int
  IdEstancia     Int
  IdUsuario      Int
  FechaEmision   DateTime
  Subtotal       Decimal
  Impuesto       Decimal
  Total          Decimal
  Estado         String

  Cliente        Clientes   @relation(fields: [IdCliente], references: [IdCliente])
  Estancia       Estancias  @relation(fields: [IdEstancia], references: [IdEstancia])
  Usuario        Usuarios   @relation(fields: [IdUsuario], references: [IdUsuario])

  Detalles       DetalleFactura[]
  Pagos          Pagos[]

  @@index([IdCliente])
  @@index([IdEstancia])
  @@index([IdUsuario])
}

model DetalleFactura {
  IdDetalle            Int                 @id @default(autoincrement())
  IdFactura            Int
  Concepto             String
  Cantidad             Decimal
  PrecioUnitario       Decimal
  TotalLinea           Decimal
  IdEstanciaHabitacion Int?

  Factura              Facturas            @relation(fields: [IdFactura], references: [IdFactura])
  EstanciaHabitacion   EstanciaHabitacion? @relation(fields: [IdEstanciaHabitacion], references: [IdEstanciaHabitacion])

  @@index([IdFactura])
  @@index([IdEstanciaHabitacion])
}

/// ========== PAGOS ==========
model Pagos {
  IdPago      Int       @id @default(autoincrement())
  IdFactura   Int
  FechaPago   DateTime
  Monto       Decimal
  MetodoPago  String
  Referencia  String?   // si quieres también puedes hacerla @unique
  Estado      String

  Factura     Facturas  @relation(fields: [IdFactura], references: [IdFactura])

  @@index([IdFactura])
}
